# Save this as ./elk/logstash/pipeline/logstash.conf
# Updated configuration to work with ILM

input {
  # HTTP input for receiving logs from applications
  http {
    port => 5001
    codec => json
  }
  
  # Beats input (for Filebeat, etc.)
  beats {
    port => 5044
  }
  
  # UDP input for syslog or simple text logs
  udp {
    port => 5002
    codec => json_lines
  }
}

filter {
  # Add timestamp if not present
  if ![timestamp] and ![@timestamp] {
    ruby {
      code => "event.set('@timestamp', Time.now.utc)"
    }
  }
  
  # Parse timestamp from timestamp field if present
  if [timestamp] and ![timestamp_parsed] {
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'" ]
      target => "@timestamp"
      add_tag => [ "timestamp_parsed" ]
    }
  }
  
  # Add service field if not present (useful for filtering)
  if ![service] {
    mutate {
      add_field => { "service" => "unknown" }
    }
  }
  
  # Add log level if not present
  if ![level] {
    mutate {
      add_field => { "level" => "info" }
    }
  }
  
  # Add host information
  if ![host] {
    mutate {
      add_field => { "host" => "%{[host][name]}" }
    }
  }
}

output {
  # Output to Elasticsearch with ILM-managed alias
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    # Use the write alias instead of date-based index
    index => "logstash-write"
    # This is important for ILM to work properly
    ilm_enabled => true
    ilm_rollover_alias => "logstash-write"
    ilm_pattern => "000001"
    ilm_policy => "logstash-policy"
  }
  
  # Also output to stdout for debugging (remove in production)
  stdout {
    codec => rubydebug
  }
}